## 로드 밸런싱 (Load Balancing)

서비스의 이용자가 많아지면서 트래픽이 늘어나면 서버의 부하가 늘게 된다.<br />
부하를 견디지 못하고 서버가 죽어버리기 전에 대비를 해야하는데, 대처 방법은 크게 두가지 방법이 있다.<br />

- Scale up : 서버 성능을 향상시킨다. (cpu 등 하드웨어의 업그레이드)
- Scale out : 서버를 증설하여 트래픽을 분산시킨다. 

Scale up의 경우는 비용이 비싸기 때문에 Scale out 방법을 많이 사용한다고 한다.<br />
다수의 서버를 사용하는데 트래픽이 한쪽으로 몰리면 의미가 또 없어지기 떄문에<br />
여러 대의 서버로 트래픽(Load)이 분산(Balancing)될 수 있도록 해주는 기술이 바로 로드 밸런싱(Load Balancing)이다.<br />
그리고 로드 밸런싱 기술을 제공하는 서비스 또는 장치를 로드 밸런서라고 한다.

## 주요 기술
### NAT (Network Address Translation)
> IP 패킷의 TCP/UDP 포트 숫자와 소스 및 목적지의 IP 주소 등을 재기록하면서 라우터를 통해 네트워크 트래픽을 주고 받는 기술

위의 설명이 정의인데 쉽게 말하면 IP를 변환하는 기술이라고 한다.<br />
사설망에서 공인망으로, 공인망에서 사설망으로 통신하고자 할 때 공인망/사설망에서 사용하는 IP로 변환시켜주는 기술이다.<br />

### DSR (Dynamic Source Routing Protocol)
서버에서 클라이언트로 돌아갈 때 목적지의 IP주소를 스위치가 아닌 클라이언트의 IP 주소로 전달해서 네트워크 스위치를 거치지 않고 바로 클라이언트를 찾아가는 개념이라고 한다.<br />
와 이거는 검색을 하면 죄다 영어 문서밖에 안나옴..;;

### Tunneling
통로를 만들어 통신할 수 있게 하는 개념으로, 로드밸런서는 클라이언트와 서버 간 중간에서 터널링을 제공해준다.

### Health Check
로드밸런서는 서버들에 대한 주기적인 Health Check를 통해 서버들의 장애 여부를 판단할 수 있다고 한다.<br />
근데 이게 로드 밸런서가 자체적으로 해준다는 말인지..? 뭔지는 잘 모르겠음..

체크 방법?도 3가지가 있다.
- L3 체크 : ICMP를 이용해 서버의 IP 주소가 통신 가능한 상태인지 확인
- L4 체크 : TCP의 3 way-handshake 기반 통신의 특성을 바탕으로 각 포트 상태를 체크. 예를 들어 HTTP의 경우 80 포트를 사용하므로 TCP 80 포트에 대한 체크를 함
- L7 체크 : 어플리케이션 계층에서 체크. 실제 웹페이지에 통신을 시도해 체크하는 방법

## 로드 밸런싱 종류
종류가 크게 하드웨어에서의 로드 밸런싱과 소프트웨어에서의 로드 밸런싱으로 나뉜다.

### 하드웨어에서의 로드 밸런싱
L2, L4, L7 로드 밸런싱이 있는데, L4와 L7 로드 밸런싱이 가장 많이 사용된다고 한다.

#### L4 로드 밸런싱
트랜스포트 레이어 레벨에서 진행되는 로드 밸런싱이다.<br />
TCP/UDP 정보를 바탕으로 진행이 되고, 패킷 레벨에서만 진행이 된다.<br />
즉, IP주소나 포트번호, MAC 주소, 전송 프로토콜 등에 따라 트래픽을 나누고 분산처리 한다.<br />
CLB(Connection Load Balancing) 또는 SLB(Session Load Balancing)라고 부르기도 한다.

근데 사용자의 IP가 수시로 바뀌는 경우에는 연속적인 서비스 제공이 어렵다.

#### L7 로드 밸런싱
L4 로드 밸런싱의 기능을 포함하면서 프로토콜(HTTP, SMTP, FTP 등)을 바탕으로도 분산 처리가 가능하다.<br />
캐싱 기능을 제공하고, 상세한 라우팅이 가능하다. 또한 비정상적인 트래픽은 사전에 필터링이 되어 안정성이 높아진다고 한다.<br />
비용은 L4보다 높다.

### 소프트웨어에서의 로드 밸런싱
기본적으로 Reverse Proxy를 기반으로 동작한다.<br />
기본적인 로드밸런싱의 기능만이 있지만 그만큼 비용적으로 저렴하고 구축이 쉽다는 장점이 있다.<br />
nginx에서 해주는 로드 밸런싱 같은걸 말하는 것 같다. 

## 로드 밸런싱 방법 (알고리즘)
### 라운드 로빈 (Round Robin)
CPU 스케줄링의 라운드 로빈 방식을 활용한 방법으로, 세션을 각 서버에 순서대로, 순차적으로 맺어주는 방식이다.<br />
단순히 순서에 따라 할당하기 때문에 같은 처리량이 보장되지는 않는다.

### 최소 연결 (Least Connection)
서버들 중 가장 적게 연결된 서버에 배정하는 방식이다. 가장 많이 사용되는 방식이라고 한다.

### 가중치 및 비율 할당 방식 (Weighted Round Robin)
서버의 처리 능력을 고려해 가중치를 부여하면서 라운드 로빈 방식을 적용한 방식이다.

### 해싱 (Hashing)
각 클라이언트에 대해 hashing key(IP + Port / IP 주소)를 통해 해당 서버에 배정하는 방식이다.<br />
특정 클라이언트는 특정 서버로만 할당이 되기 때문에 경로가 보장이 되며 접속자 수가 많을 수록 분산 및 효율이 뛰어나다.<br />

### URL 스위칭 방식 (URL Switching)
특정 URL들은 특정 서버로 처리하는 방식이다.

### 컨텍스트 스위칭 방식 (Context Switching)
클라이언트가 요청한 특정 리소스에 대해 특정 서버 등으로 연결 해주는 방식이다.

### 쿠키 지속성 (Persistence with Cookies)
쿠키 정보를 바탕으로 클라이언트가 연결했었던 동일한 서버에 계속 할당해주는 방식이다.

## 단점
단점이라기 보다 로드 밸런싱 사용 시 어려운 점이 세션 데이터 관리이다.<br />
예를 들어 로그인은 A 서버에서 했는데 다음 요청은 B 서버로 들어가버리면 로그인한 데이터가 없기 때문에 다시 로그인해야하는 상황이 생긴다.<br />

근데 이 단점은 sticky session? 그걸로도 해결할 수도 있고.. 뭐..

근데 또 이렇게 고정시켜버리면 고정한 서버에서 장애가 발생하면 문제가 되기 때문에 그런 상황에 대한 고려도 필요하다.

크.. 백엔드 쉽지 않지 그치그치..

그리고 로드 밸런서에 문제가 생길 수도 있으니 로드 밸런서를 이중화시켜서 대비해야 하기도 한다.

## 결론
로드 밸런싱은 그냥 진짜 간단하게 트래픽 분산 시켜주는 거! 라고만 알고 있었는데<br />
맞긴 맞지만 좀 더 자세하게 봐서 좋긴 했음<br />
근데 어제에 이어서 보면 볼 수록... 뭔가... 일단 우리 회사 서비스가 어떤 구조로 되어있는건지 다시 한번 알아봐야 하겠다는 생각이 들었다.<br />
헷갈린다고 해야하나.. 뭔가 좀.. 알고 있는 것들이 머리 속에서 뒤섞여서 돌아다니느라 정리도 잘 안됨

<br />

참고
- [1](https://www.stevenjlee.net/2020/06/30/%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%EC%9D%98-%EB%B6%80%ED%95%98%EB%B6%84%EC%82%B0-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-load-balancing-%EA%B7%B8/)
- [2](https://sorjfkrh5078.tistory.com/147)
- [3](https://velog.io/@kimjiwonpg98/Nginx-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EA%B0%9C%EB%85%90-%EB%B0%8F-%EA%B5%AC%EC%B6%95#1-%ED%95%98%EB%93%9C%EC%9B%A8%EC%96%B4%EC%97%90%EC%84%9C%EC%9D%98-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1)